rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // 테스트 컬렉션 - 개발 중에는 읽기 허용
    match /test/{document=**} {
      allow read: if true;
      allow write: if false;
    }
    
    // === 5-컬렉션 구조 ===
    
    // 1. words - 마스터 단어 DB (인증된 사용자 읽기 가능)
    match /words/{wordId} {
      allow read: if request.auth != null;
      // 인증된 사용자는 새 단어 추가 가능 (PDF 업로드 등)
      allow create: if request.auth != null;
      // 수정과 삭제는 관리자만 (추후 관리자 체크 추가)
      allow update, delete: if false;
    }
    
    // 2. vocabularies - 단어장 컬렉션 (인증된 사용자 읽기 가능)
    match /vocabularies/{vocabularyId} {
      allow read: if request.auth != null;
      allow write: if false; // 관리자만 수정 가능
    }
    
    // 3. vocabulary_words - 단어장-단어 연결 (인증된 사용자 읽기 가능)
    match /vocabulary_words/{linkId} {
      allow read: if request.auth != null;
      allow write: if false; // 관리자만 수정 가능
    }
    
    // 4. user_vocabularies - 사용자 단어장 구독 (본인만 접근 가능)
    match /user_vocabularies/{userVocabId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    // 5. user_words - 사용자 학습 진도 (본인만 접근 가능)
    match /user_words/{userWordId} {
      // userWordId 형식이 userId_wordId인 경우 체크
      allow read: if request.auth != null && 
        (userWordId.split('_')[0] == request.auth.uid || 
         (resource != null && resource.data.userId == request.auth.uid));
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // 6. vocabulary_collections - 단어장 컬렉션 (공개/비공개 구분)
    match /vocabulary_collections/{collectionId} {
      // 읽기 권한을 단순화 - 인증된 사용자는 모두 읽기 가능
      // 실제 데이터 필터링은 앱 로직에서 처리
      allow read: if request.auth != null;
      // 생성은 인증된 사용자 누구나 가능
      allow create: if request.auth != null;
      // 수정은 소유자 또는 admin 소유 컬렉션
      allow update: if request.auth != null && 
        (resource.data.userId == request.auth.uid || 
         resource.data.userId == 'admin');
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    // 사용자 설정 - 본인만 접근 가능
    match /userSettings/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // === 기존 컬렉션들 (호환성 유지) ===
    
    // 사용자 프로필 데이터 - 본인만 접근 가능
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // 사용자의 개인 설정
      match /preferences/{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // 사용자의 학습 진도
      match /progress/{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // SAT 어휘 데이터 - 인증된 사용자만 읽기 가능 (구 컬렉션)
    match /vocabulary/{wordId} {
      allow read: if request.auth != null;
      allow write: if false; // 관리자만 수정 가능 (추후 Admin SDK 사용)
      
      // 어휘 관련 메타데이터
      match /metadata/{document=**} {
        allow read: if request.auth != null;
        allow write: if false;
      }
    }
    
    // 뉴스 기사 데이터 - 인증된 사용자만 읽기 가능
    match /news/{articleId} {
      allow read: if request.auth != null;
      allow write: if false; // 시스템에서만 생성
    }
    
    // 학습 진도 추적 - 본인 데이터만 접근
    match /progress/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      match /words/{wordId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // 퀴즈 결과 - 본인 데이터만 접근
    match /quiz_results/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      match /sessions/{sessionId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // 분석 데이터 - 읽기 전용 (인증된 사용자)
    match /analytics/{document=**} {
      allow read: if request.auth != null;
      allow write: if false; // 시스템에서만 생성
    }
    
    // 기본적으로 모든 접근 차단
    match /{document=**} {
      allow read, write: if false;
    }
  }
}